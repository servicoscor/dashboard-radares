<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Radar Nowcast - COR Rio</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* Vari√°veis de Tema */
        :root {
            --bg-primary: #0f1419;
            --bg-secondary: #1a1f26;
            --bg-tertiary: #242b33;
            --border-color: #2f3942;
            --text-primary: #ffffff;
            --text-secondary: #8899a6;
            --accent-color: #00d4ff;
            --success-color: #00ff88;
            --controls-bg: rgba(50, 55, 65, 0.95);
            --card-bg: #0f1419;
        }
        
        /* Modo Claro - Paleta Oficial Prefeitura Rio */
        body.light-mode {
            --bg-primary: #eceded;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e0e0e0;
            --border-color: #c5c5c5;
            --text-primary: #13335a;
            --text-secondary: #4a6a8a;
            --accent-color: #13335a;
            --success-color: #00aa55;
            --controls-bg: rgba(255, 255, 255, 0.95);
            --card-bg: #ffffff;
        }
        
        /* Corre√ß√µes espec√≠ficas para modo claro */
        body.light-mode .radar-btn {
            color: #13335a;
            background: #ffffff;
            border: 1px solid #c5c5c5;
        }
        body.light-mode .radar-btn:hover {
            background: #e0e0e0;
            color: #13335a;
        }
        body.light-mode .radar-btn.active {
            background: #13335a;
            color: #ffffff;
            border-color: #13335a;
        }
        body.light-mode .header-btn {
            color: #13335a;
            border-color: #c5c5c5;
        }
        body.light-mode .header-btn:hover {
            background: #e0e0e0;
            border-color: #13335a;
        }
        body.light-mode .map-btn {
            color: #13335a;
            background: #ffffff;
            border-color: #c5c5c5;
        }
        body.light-mode .map-btn:hover {
            background: #e0e0e0;
        }
        body.light-mode .map-btn.active {
            background: #13335a;
            color: #ffffff;
        }
        body.light-mode .theme-toggle {
            color: #13335a;
            border-color: #c5c5c5;
        }
        body.light-mode .ctrl-btn:hover {
            background: rgba(0, 0, 0, 0.1);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: var(--bg-primary); 
            color: var(--text-primary); 
            height: 100vh; 
            overflow: hidden;
            transition: background 0.3s ease, color 0.3s ease;
        }
        
        /* Container principal */
        .container { 
            display: grid; 
            grid-template-columns: 1fr 300px; 
            grid-template-rows: 60px 1fr; 
            height: 100vh; 
            transition: grid-template-columns 0.3s ease; 
        }
        .container.fullscreen { grid-template-columns: 1fr 0; }
        .container.fullscreen .sidebar { display: none; }
        
        /* Header */
        header { 
            grid-column: 1 / -1; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 0 20px; 
            background: var(--bg-secondary); 
            border-bottom: 1px solid var(--border-color);
            transition: background 0.3s ease, border-color 0.3s ease;
        }
        .logo { display: flex; align-items: center; }
        .logo img { height: 40px; }
        .header-controls { display: flex; align-items: center; gap: 12px; }
        .radar-selector { display: flex; gap: 4px; background: var(--bg-primary); padding: 4px; border-radius: 10px; transition: background 0.3s ease; }
        .radar-btn { padding: 8px 14px; border: none; background: transparent; color: var(--text-secondary); font-size: 0.85rem; font-weight: 500; border-radius: 8px; cursor: pointer; transition: all 0.2s; white-space: nowrap; }
        .radar-btn:hover { color: var(--text-primary); background: var(--bg-tertiary); }
        .radar-btn.active { background: var(--accent-color); color: #000; }
        .header-btn { padding: 8px 12px; border: 1px solid var(--border-color); background: transparent; color: var(--text-secondary); font-size: 0.85rem; border-radius: 8px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px; }
        .header-btn:hover { border-color: var(--accent-color); color: var(--text-primary); }
        .header-btn.active { background: var(--accent-color); color: #000; border-color: var(--accent-color); }
        .status { display: flex; align-items: center; gap: 8px; background: var(--bg-primary); padding: 8px 14px; border-radius: 20px; transition: background 0.3s ease; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--success-color); animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        /* Bot√£o de tema */
        .theme-toggle {
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            background: transparent;
            color: var(--text-secondary);
            font-size: 1rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .theme-toggle:hover { border-color: var(--accent-color); color: var(--text-primary); }
        
        /* Bot√£o toggle sidebar mobile */
        .sidebar-toggle {
            display: none;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            background: transparent;
            color: var(--text-secondary);
            font-size: 1.2rem;
            border-radius: 8px;
            cursor: pointer;
        }
        .sidebar-toggle.active { background: var(--accent-color); color: #000; border-color: var(--accent-color); }
        
        /* Map area */
        .map-area { position: relative; }
        #map { width: 100%; height: 100%; }
        #externalRadar { width: 100%; height: 100%; border: none; display: none; }
        
        /* Iframe recortado para Niter√≥i */
        .iframe-cropped-container {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
            display: none;
        }
        .iframe-cropped-container iframe {
            position: absolute;
            top: -119px;
            left: -5px;
            width: calc(100% + 10px);
            height: calc(100% + 98px);
            border: none;
        }
        
        /* Controls player */
        .controls { 
            position: absolute; 
            bottom: 20px; 
            left: 50%; 
            transform: translateX(-50%); 
            display: flex; 
            align-items: center; 
            gap: 8px; 
            padding: 8px 16px; 
            background: var(--controls-bg); 
            border-radius: 8px; 
            z-index: 1000; 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            border: 1px solid var(--border-color);
            transition: background 0.3s ease, border-color 0.3s ease;
        }
        
        /* Legenda overlay no mapa */
        .legend-overlay {
            position: absolute;
            bottom: 80px;
            left: 10px;
            background: rgba(15, 20, 25, 0.9);
            padding: 8px 12px;
            border-radius: 8px;
            z-index: 1000;
            font-size: 11px;
            border: 1px solid var(--border-color);
            transition: background 0.3s ease, border-color 0.3s ease;
        }
        body.light-mode .legend-overlay {
            background: rgba(255, 255, 255, 0.95);
        }
        .legend-overlay-title {
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text-primary);
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .legend-overlay-items {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        .legend-overlay-item {
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .legend-overlay-color {
            width: 20px;
            height: 10px;
            border-radius: 2px;
            flex-shrink: 0;
        }
        .legend-overlay-label {
            color: var(--text-secondary);
            font-size: 10px;
        }
        .legend-overlay-filtered {
            opacity: 0.5;
            font-style: italic;
        }
        .ctrl-btn { 
            width: 32px; 
            height: 32px; 
            border: none; 
            background: transparent; 
            color: var(--text-primary); 
            cursor: pointer; 
            font-size: 14px; 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border-radius: 4px; 
            transition: background 0.2s; 
        }
        .ctrl-btn:hover { background: rgba(255,255,255,0.1); }
        .ctrl-btn.playing { color: var(--accent-color); }
        .time-display { font-size: 14px; color: var(--text-primary); font-weight: 500; min-width: 150px; text-align: center; }
        .timeline-container { display: flex; align-items: center; gap: 8px; }
        .timeline { width: 180px; height: 4px; background: var(--border-color); border-radius: 2px; cursor: pointer; position: relative; }
        .timeline-bar { height: 100%; background: var(--accent-color); border-radius: 2px; width: 0%; position: relative; transition: width 0.1s linear; }
        .timeline-handle { position: absolute; right: -6px; top: 50%; transform: translateY(-50%); width: 12px; height: 12px; background: var(--text-primary); border-radius: 50%; box-shadow: 0 1px 3px rgba(0,0,0,0.3); }
        .fps-display { display: flex; align-items: center; gap: 4px; color: var(--text-secondary); font-size: 13px; }
        .fps-icon { font-size: 16px; }
        .frame-counter { color: var(--text-secondary); font-size: 12px; margin-left: 4px; }
        
        /* Sidebar */
        .sidebar { 
            background: var(--bg-secondary); 
            padding: 16px; 
            overflow-y: auto; 
            border-left: 1px solid var(--border-color); 
            transition: all 0.3s ease; 
        }
        .card { background: var(--card-bg); border-radius: 12px; padding: 16px; margin-bottom: 16px; border: 1px solid var(--border-color); transition: background 0.3s ease, border-color 0.3s ease; }
        .card-title { font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; margin-bottom: 12px; border-left: 3px solid var(--accent-color); padding-left: 8px; }
        .info-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid var(--border-color); }
        .info-row:last-child { border: none; }
        .info-label { color: var(--text-secondary); font-size: 0.85rem; }
        .info-value { font-weight: 600; }
        .legend { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .legend-item { display: flex; align-items: center; gap: 8px; font-size: 0.75rem; }
        .legend-color { width: 20px; height: 12px; border-radius: 3px; }
        .toggle-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; }
        .toggle-label { font-size: 0.85rem; }
        .toggle { position: relative; width: 44px; height: 24px; background: var(--border-color); border-radius: 12px; cursor: pointer; transition: background 0.3s; }
        .toggle.active { background: var(--accent-color); }
        .toggle::after { content: ''; position: absolute; top: 2px; left: 2px; width: 20px; height: 20px; background: #fff; border-radius: 50%; transition: left 0.3s; }
        .toggle.active::after { left: 22px; }
        .nucleus-list { max-height: 150px; overflow-y: auto; }
        .nucleus-item { display: flex; align-items: center; gap: 10px; padding: 8px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 6px; border: 1px solid var(--border-color); }
        .nucleus-icon { width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        .nucleus-info { flex: 1; }
        .nucleus-name { font-size: 0.85rem; font-weight: 600; }
        .nucleus-dir { font-size: 0.7rem; color: var(--text-secondary); }
        .nucleus-speed { font-size: 0.9rem; font-weight: 600; color: var(--accent-color); }
        .arrow-marker { background: transparent !important; border: none !important; }
        .map-selector { display: flex; flex-wrap: wrap; gap: 6px; }
        .map-btn { padding: 6px 10px; border: 1px solid var(--border-color); background: var(--bg-secondary); color: var(--text-secondary); border-radius: 6px; cursor: pointer; font-size: 0.75rem; transition: all 0.2s; }
        .map-btn:hover { border-color: var(--accent-color); color: var(--text-primary); }
        .map-btn.active { background: var(--accent-color); color: #000; border-color: var(--accent-color); }
        .loading { color: var(--accent-color); font-size: 0.8rem; }
        .external-info { color: var(--text-secondary); font-size: 0.85rem; line-height: 1.5; }
        .external-link { color: var(--accent-color); text-decoration: none; }
        .external-link:hover { text-decoration: underline; }
        .download-btn { width: 100%; padding: 12px; border: none; background: linear-gradient(135deg, #00d4ff, #00ff88); color: #000; font-weight: 600; font-size: 0.9rem; border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; transition: transform 0.2s, box-shadow 0.2s; }
        .download-btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0, 212, 255, 0.3); }
        .download-btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .download-btn .icon { font-size: 1.1rem; }
        .loading-overlay { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--controls-bg); padding: 20px 30px; border-radius: 10px; z-index: 2000; text-align: center; border: 1px solid var(--border-color); }
        .loading-spinner { width: 40px; height: 40px; border: 3px solid var(--border-color); border-top-color: var(--accent-color); border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Alerta de atraso do radar */
        .delay-alert {
            position: absolute;
            top: 70px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255, 59, 48, 0.95);
            color: #fff;
            padding: 10px 20px;
            border-radius: 8px;
            z-index: 1500;
            display: none;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
            font-weight: 500;
            box-shadow: 0 4px 12px rgba(255, 59, 48, 0.4);
            animation: pulse-alert 2s infinite;
        }
        .delay-alert.warning {
            background: rgba(255, 149, 0, 0.95);
            box-shadow: 0 4px 12px rgba(255, 149, 0, 0.4);
        }
        .delay-alert-icon { font-size: 1.2rem; }
        .delay-alert-time { font-weight: 700; }
        @keyframes pulse-alert {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.85; }
        }
        @media (max-width: 768px) {
            .delay-alert {
                top: 60px;
                padding: 8px 14px;
                font-size: 0.8rem;
                max-width: 90%;
            }
        }

        /* ============================================ */
        /* MOBILE BOTTOM BAR - Radar e Mapa selector */
        /* ============================================ */
        .mobile-bottom-bar {
            display: none;
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-color);
            padding: 8px;
            z-index: 1002;
            flex-direction: column;
            gap: 8px;
            transition: background 0.3s ease, border-color 0.3s ease;
        }
        .mobile-radar-selector {
            display: flex;
            gap: 4px;
            justify-content: center;
        }
        .mobile-radar-selector .radar-btn {
            flex: 1;
            text-align: center;
            padding: 10px 8px;
            font-size: 0.8rem;
        }
        .mobile-map-selector {
            display: flex;
            gap: 4px;
            justify-content: center;
            overflow-x: auto;
            padding-bottom: 4px;
        }
        .mobile-map-selector .map-btn {
            padding: 6px 12px;
            font-size: 0.7rem;
            white-space: nowrap;
        }

        /* ============================================ */
        /* RESPONSIVO - TABLET (768px - 1024px) */
        /* ============================================ */
        @media (max-width: 1024px) {
            .container { grid-template-columns: 1fr 260px; }
            .radar-btn { padding: 6px 10px; font-size: 0.8rem; }
            .header-btn span:last-child { display: none; }
            .status span { display: none; }
            .timeline { width: 120px; }
            .time-display { min-width: 130px; font-size: 13px; }
        }

        /* ============================================ */
        /* RESPONSIVO - TABLET PEQUENO (600px - 768px) */
        /* ============================================ */
        @media (max-width: 768px) {
            .container { 
                grid-template-columns: 1fr; 
                grid-template-rows: 56px 1fr; 
            }
            
            header { padding: 0 12px; }
            .logo img { height: 32px; }
            
            .header-controls { gap: 8px; }
            
            /* Esconder seletores do header no mobile */
            .radar-selector { display: none; }
            
            .header-btn { padding: 6px 10px; }
            .header-btn span:last-child { display: none; }
            
            .status { padding: 6px 10px; }
            .status span { display: none; }
            
            .sidebar-toggle { display: flex; }
            
            /* Sidebar como bottom sheet */
            .sidebar {
                position: fixed;
                bottom: 90px;
                left: 0;
                right: 0;
                max-height: 45vh;
                border-left: none;
                border-top: 1px solid var(--border-color);
                border-radius: 20px 20px 0 0;
                transform: translateY(100%);
                transition: transform 0.3s ease;
                z-index: 1001;
                padding-top: 24px;
            }
            .sidebar::before {
                content: '';
                position: absolute;
                top: 10px;
                left: 50%;
                transform: translateX(-50%);
                width: 40px;
                height: 4px;
                background: #2f3942;
                border-radius: 2px;
            }
            .sidebar.open { transform: translateY(0); }
            
            .container.fullscreen .sidebar { display: block; }
            
            /* Mostrar barra inferior mobile */
            .mobile-bottom-bar { display: flex; }
            
            /* Controls adaptados */
            .controls {
                bottom: 100px;
                padding: 6px 12px;
                gap: 6px;
                width: calc(100% - 20px);
                max-width: 500px;
            }
            .timeline { width: 80px; }
            .time-display { min-width: 110px; font-size: 12px; }
            .fps-display { display: none; }
            
            .card { padding: 12px; margin-bottom: 12px; }
            
            /* Esconder card de mapa na sidebar (j√° est√° na barra inferior) */
            #mapCard { display: none; }
            
            .legend-overlay {
                bottom: 75px;
                left: 8px;
                padding: 6px 10px;
            }
            .legend-overlay-title { font-size: 9px; margin-bottom: 4px; }
            .legend-overlay-label { font-size: 9px; }
            .legend-overlay-color { width: 16px; height: 8px; }
        }

        /* ============================================ */
        /* RESPONSIVO - MOBILE (at√© 480px) */
        /* ============================================ */
        @media (max-width: 480px) {
            .container { grid-template-rows: 50px 1fr; }
            
            header { padding: 0 8px; }
            .logo img { height: 28px; }
            
            .header-controls { gap: 6px; }
            
            #fullscreenBtn { display: none; }
            
            .sidebar-toggle { 
                display: flex; 
                padding: 6px 10px;
                font-size: 1rem;
            }
            
            .sidebar {
                max-height: 50vh;
                padding: 20px 12px 12px;
                bottom: 100px;
            }
            
            .controls {
                bottom: 110px;
                padding: 8px 10px;
                gap: 4px;
                flex-wrap: wrap;
                justify-content: center;
            }
            .ctrl-btn { width: 36px; height: 36px; font-size: 16px; }
            .timeline-container { 
                order: 1; 
                width: 100%; 
                justify-content: center;
                margin-top: 4px;
            }
            .timeline { width: 150px; height: 6px; }
            .timeline-handle { width: 16px; height: 16px; }
            .time-display { 
                font-size: 13px; 
                min-width: auto;
                order: 0;
            }
            .frame-counter { display: none; }
            
            .card-title { font-size: 0.7rem; }
            .info-label, .info-value { font-size: 0.8rem; }
            .legend { grid-template-columns: 1fr; }
            .nucleus-list { max-height: 100px; }
            
            .mobile-bottom-bar { padding: 6px 8px; gap: 6px; }
            .mobile-radar-selector .radar-btn { padding: 8px 6px; font-size: 0.75rem; }
            .mobile-map-selector .map-btn { padding: 5px 10px; font-size: 0.65rem; }
            
            .legend-overlay {
                bottom: 115px;
                left: 5px;
                padding: 5px 8px;
            }
            .legend-overlay-items { gap: 2px; }
            .legend-overlay-title { font-size: 8px; margin-bottom: 3px; }
            .legend-overlay-label { font-size: 8px; }
            .legend-overlay-color { width: 14px; height: 6px; }
        }

        /* ============================================ */
        /* RESPONSIVO - MOBILE PEQUENO (at√© 360px) */
        /* ============================================ */
        @media (max-width: 360px) {
            .logo img { height: 24px; }
            .sidebar-toggle { padding: 5px 8px; }
            
            .controls { padding: 6px 8px; }
            .ctrl-btn { width: 32px; height: 32px; }
            .time-display { font-size: 12px; }
            .timeline { width: 120px; }
            
            .mobile-radar-selector .radar-btn { padding: 6px 4px; font-size: 0.7rem; }
        }

        /* ============================================ */
        /* LANDSCAPE MOBILE */
        /* ============================================ */
        @media (max-height: 500px) and (orientation: landscape) {
            .container { grid-template-rows: 45px 1fr; }
            header { padding: 0 10px; }
            .logo img { height: 28px; }
            
            .sidebar { max-height: 60vh; bottom: 70px; }
            
            .mobile-bottom-bar { 
                flex-direction: row; 
                padding: 4px 8px;
                gap: 10px;
            }
            .mobile-radar-selector { flex: 1; }
            .mobile-map-selector { flex: 1; }
            
            .controls {
                bottom: 75px;
                padding: 4px 10px;
            }
            .ctrl-btn { width: 28px; height: 28px; font-size: 12px; }
        }
    </style>
</head>
<body>
    <div class="container" id="container">
        <header>
            <div class="logo">
                <img src="logo-cor.png" alt="Centro de Opera√ß√µes Rio">
            </div>
            <div class="header-controls">
                <div class="radar-selector">
                    <button class="radar-btn active" data-radar="mendanha">Mendanha</button>
                    <button class="radar-btn" data-radar="sumare">Sumar√©</button>
                    <button class="radar-btn" data-radar="niteroi">Niter√≥i</button>
                </div>
                <button class="header-btn" id="mosaicBtn" onclick="window.location.href='mosaic.html'">
                    <span>‚äû</span> <span>Mosaico</span>
                </button>
                <button class="theme-toggle" id="themeToggle" title="Alternar tema">
                    <span id="themeIcon">‚òÄÔ∏è</span>
                </button>
                <button class="header-btn" id="fullscreenBtn">
                    <span id="fullscreenIcon">‚õ∂</span> <span id="fullscreenText">Expandir</span>
                </button>
                <button class="sidebar-toggle" id="sidebarToggle">‚ò∞</button>
                <div class="status"><div class="status-dot"></div><span id="statusText">Conectado</span></div>
            </div>
        </header>
        <div class="map-area">
            <div id="map"></div>
            <div class="delay-alert" id="delayAlert">
                <span class="delay-alert-icon">‚ö†Ô∏è</span>
                <span>Radar Mendanha sem atualiza√ß√£o h√° <span class="delay-alert-time" id="delayTime">0</span> minutos</span>
            </div>
            <div class="loading-overlay" id="loadingOverlay" style="display:none;">
                <div class="loading-spinner"></div>
                <div id="loadingText">Carregando imagens...</div>
            </div>
            
            <!-- Legenda overlay no mapa -->
            <div class="legend-overlay" id="legendOverlay">
                <div class="legend-overlay-title">Precipita√ß√£o (mm/h)</div>
                <div class="legend-overlay-items">
                    <div class="legend-overlay-item"><div class="legend-overlay-color" style="background:linear-gradient(to right, #ff00ff, #ffaaff)"></div><span class="legend-overlay-label">500-1100</span></div>
                    <div class="legend-overlay-item"><div class="legend-overlay-color" style="background:#ff0000"></div><span class="legend-overlay-label">100-500</span></div>
                    <div class="legend-overlay-item"><div class="legend-overlay-color" style="background:#ff9900"></div><span class="legend-overlay-label">50-100</span></div>
                    <div class="legend-overlay-item"><div class="legend-overlay-color" style="background:#ffff00"></div><span class="legend-overlay-label">10-50</span></div>
                    <div class="legend-overlay-item"><div class="legend-overlay-color" style="background:#00cc00"></div><span class="legend-overlay-label">5-10</span></div>
                    <div class="legend-overlay-item"><div class="legend-overlay-color" style="background:#00ff00"></div><span class="legend-overlay-label">1-5</span></div>
                    <div class="legend-overlay-item legend-overlay-filtered"><div class="legend-overlay-color" style="background:#00ffff"></div><span class="legend-overlay-label">0.5-1 (filtrado)</span></div>
                    <div class="legend-overlay-item legend-overlay-filtered"><div class="legend-overlay-color" style="background:#0099ff"></div><span class="legend-overlay-label">0.1-0.5 (filtrado)</span></div>
                </div>
            </div>
            
            <iframe id="externalRadar" src=""></iframe>
            <div class="iframe-cropped-container" id="niteroiContainer">
                <iframe id="niteroiRadar" src=""></iframe>
            </div>
            <div class="controls" id="controls">
                <button class="ctrl-btn" id="prevBtn">‚è™</button>
                <button class="ctrl-btn" id="playBtn">‚ñ∂</button>
                <button class="ctrl-btn" id="nextBtn">‚è©</button>
                <div class="time-display" id="timeDisplay">Carregando...</div>
                <div class="timeline-container">
                    <div class="timeline" id="timeline">
                        <div class="timeline-bar" id="timelineBar">
                            <div class="timeline-handle"></div>
                        </div>
                    </div>
                    <span class="frame-counter" id="frameCounter">0/0</span>
                </div>
                <div class="fps-display">
                    <span class="fps-icon">‚è±</span>
                    <span>1.5fps</span>
                </div>
            </div>
        </div>
        <div class="sidebar" id="sidebar">
            <div class="card" id="radarInfoCard">
                <div class="card-title" id="radarTitle">Radar Mendanha</div>
                <div id="mendanhaInfo">
                    <div class="info-row"><span class="info-label">Fonte</span><span class="info-value">INEA</span></div>
                    <div class="info-row"><span class="info-label">Frames</span><span class="info-value" id="frameCount">0</span></div>
                    <div class="info-row"><span class="info-label">Atual</span><span class="info-value" id="currentFrameNum">0</span></div>
                    <div class="info-row"><span class="info-label">N√∫cleos</span><span class="info-value" id="nucleiCount">0</span></div>
                </div>
                <div id="sumareInfo" style="display:none;">
                    <div class="info-row"><span class="info-label">Fonte</span><span class="info-value">AlertaRio</span></div>
                    <div class="info-row"><span class="info-label">Frames</span><span class="info-value" id="sumareFrameCount">0</span></div>
                    <div class="info-row"><span class="info-label">Atual</span><span class="info-value" id="sumareFrameNum">0</span></div>
                    <div class="info-row"><span class="info-label">N√∫cleos</span><span class="info-value" id="sumareNucleiCount">0</span></div>
                </div>
                <div id="niteroiInfo" style="display:none;">
                    <p class="external-info">
                        Radar Banda X - Defesa Civil de Niter√≥i.<br>
                        Alcance: 100km | Parque da Cidade<br><br>
                        <a href="https://radar.niteroi.rj.gov.br/" target="_blank" class="external-link">Abrir em nova aba ‚Üó</a>
                    </p>
                </div>
            </div>
            
            <div class="card" id="exportCard">
                <div class="card-title">Exportar Anima√ß√£o</div>
                <button class="download-btn" id="downloadGif">
                    <span class="icon">üì•</span>
                    <span>Baixar GIF</span>
                </button>
            </div>
            
            <div class="card" id="mapCard">
                <div class="card-title">Tipo de Mapa</div>
                <div class="map-selector">
                    <button class="map-btn active" data-map="dark">Escuro</button>
                    <button class="map-btn" data-map="light">Claro</button>
                    <button class="map-btn" data-map="streets">Ruas</button>
                    <button class="map-btn" data-map="satellite">Sat√©lite</button>
                    <button class="map-btn" data-map="topo">Topo</button>
                </div>
            </div>
            <div class="card" id="configCard">
                <div class="card-title">Configura√ß√µes</div>
                <div class="toggle-row"><span class="toggle-label">Marcador radar</span><div class="toggle" id="toggleMarker"></div></div>
                <div class="toggle-row" id="arrowsToggleRow"><span class="toggle-label">Setas de dire√ß√£o</span><div class="toggle active" id="toggleArrows"></div></div>
                <div class="toggle-row"><span class="toggle-label">Opacidade alta</span><div class="toggle" id="toggleOpacity"></div></div>
                <div class="toggle-row" id="filterRainRow"><span class="toggle-label">Filtrar umidade (s√≥ chuva)</span><div class="toggle active" id="toggleFilterRain"></div></div>
            </div>
            <div class="card" id="nucleiCard">
                <div class="card-title">N√∫cleos Detectados</div>
                <div class="nucleus-list" id="nucleusList"><div class="loading">Analisando frames...</div></div>
            </div>
        </div>
    </div>
    
    <!-- Barra inferior mobile -->
    <div class="mobile-bottom-bar" id="mobileBottomBar">
        <div class="mobile-radar-selector">
            <button class="radar-btn active" data-radar="mendanha">Mendanha</button>
            <button class="radar-btn" data-radar="sumare">Sumar√©</button>
            <button class="radar-btn" data-radar="niteroi">Niter√≥i</button>
        </div>
        <div class="mobile-map-selector">
            <button class="map-btn active" data-map="dark">Escuro</button>
            <button class="map-btn" data-map="light">Claro</button>
            <button class="map-btn" data-map="streets">Ruas</button>
            <button class="map-btn" data-map="satellite">Sat√©lite</button>
            <button class="map-btn" data-map="topo">Topo</button>
        </div>
    </div>
    
    <canvas id="analysisCanvas" style="display:none;"></canvas>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        // Configura√ß√µes
        const ANIMATION_SPEED = 650;
        const BASE_OPACITY = 0.7;
        const HIGH_OPACITY = 0.9;
        
        // Configura√ß√µes dos radares
        const RADAR_CONFIG = {
            mendanha: {
                bounds: [[-24.8, -46.5], [-20.8, -40.5]],
                center: [-22.75, -43.4],  // Ajustado para focar no Rio
                zoom: 9,  // Zoom mais pr√≥ximo
                markerPos: [-22.8167, -43.5500],
                markerName: 'Radar Mendanha',
                apiFrames: '/api/frames/mendanha',
                apiFrame: '/api/frame/mendanha/'
            },
            sumare: {
                bounds: [[-24.431567, -45.336972], [-21.478793, -41.159092]],
                center: [-22.9332614, -43.4324536],
                zoom: 9,
                markerPos: [-22.9596, -43.2807],
                markerName: 'Radar Sumar√©',
                apiFrames: '/api/frames/sumare',
                apiFrame: '/api/frame/sumare/'
            }
        };
        
        const MAP_LAYERS = {
            dark: L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', { attribution: 'CartoDB' }),
            light: L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', { attribution: 'CartoDB' }),
            streets: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: 'OpenStreetMap' }),
            satellite: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', { attribution: 'Esri' }),
            topo: L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', { attribution: 'OpenTopoMap' })
        };
        
        let map, radarMarker, arrowsLayer, currentTileLayer;
        let frames = [], currentFrame = 0, isPlaying = false, playInterval;
        let currentOpacity = BASE_OPACITY, showArrows = true;
        let allFramesData = { mendanha: [], sumare: [] };
        let currentRadar = 'mendanha';
        let frameOverlays = [];
        let imagesReady = false;
        let filterRainOnly = true;  // Filtro de chuva ativado por padr√£o
        let currentDelayMinutes = 0;  // Atraso atual do radar em minutos
        const DELAY_WARNING_THRESHOLD = 30;  // Mostrar alerta ap√≥s 30 min
        const DELAY_CRITICAL_THRESHOLD = 60;  // Alerta cr√≠tico ap√≥s 60 min

        // Sidebar toggle mobile
        document.getElementById('sidebarToggle').onclick = function() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('open');
            this.classList.toggle('active');
        };

        // Fechar sidebar ao clicar fora (mobile)
        document.getElementById('map').addEventListener('click', function() {
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('open');
                document.getElementById('sidebarToggle').classList.remove('active');
            }
        });

        // Fullscreen toggle
        let isFullscreen = false;
        document.getElementById('fullscreenBtn').onclick = function() {
            isFullscreen = !isFullscreen;
            document.getElementById('container').classList.toggle('fullscreen', isFullscreen);
            document.getElementById('fullscreenIcon').textContent = isFullscreen ? '‚äü' : '‚õ∂';
            document.getElementById('fullscreenText').textContent = isFullscreen ? 'Recolher' : 'Expandir';
            this.classList.toggle('active', isFullscreen);
            setTimeout(() => map.invalidateSize(), 350);
        };

        // Theme toggle (modo escuro/claro)
        let isDarkMode = localStorage.getItem('theme') !== 'light';
        
        function applyTheme() {
            document.body.classList.toggle('light-mode', !isDarkMode);
            document.getElementById('themeIcon').textContent = isDarkMode ? '‚òÄÔ∏è' : 'üåô';
            
            // Trocar logo baseado no tema
            const logo = document.querySelector('.logo img');
            if (logo) {
                logo.src = isDarkMode ? 'logo-cor.png' : 'logo-cor-azul.png';
            }
            
            // Trocar mapa base automaticamente
            if (map && currentTileLayer) {
                const currentMapType = document.querySelector('.map-btn.active')?.dataset.map;
                // Se estiver no mapa escuro/claro padr√£o, trocar junto com o tema
                if ((currentMapType === 'dark' || currentMapType === 'light') && !isDarkMode) {
                    switchMap('streets');
                } else if (currentMapType === 'streets' && isDarkMode) {
                    switchMap('dark');
                }
            }
        }
        
        document.getElementById('themeToggle').onclick = function() {
            isDarkMode = !isDarkMode;
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
            applyTheme();
        };
        
        // Aplicar tema salvo ao carregar
        applyTheme();

        function createArrowIcon(angle) {
            const svg = `<svg width="44" height="44" viewBox="0 0 44 44" xmlns="http://www.w3.org/2000/svg">
                <g transform="rotate(${angle}, 22, 22)">
                    <line x1="22" y1="36" x2="22" y2="12" stroke="#000" stroke-width="6" stroke-linecap="round"/>
                    <line x1="22" y1="36" x2="22" y2="12" stroke="#fff" stroke-width="3" stroke-linecap="round"/>
                    <polygon points="22,6 13,18 31,18" fill="#000" stroke="#000" stroke-width="2"/>
                    <polygon points="22,8 15,17 29,17" fill="#fff"/>
                </g>
            </svg>`;
            return L.divIcon({
                html: svg,
                className: 'arrow-marker',
                iconSize: [44, 44],
                iconAnchor: [22, 22]
            });
        }

        // Ajustar zoom inicial baseado no tamanho da tela
        function getInitialZoom() {
            const baseZoom = RADAR_CONFIG[currentRadar]?.zoom || 9;
            if (window.innerWidth <= 480) return baseZoom - 1;
            if (window.innerWidth <= 768) return baseZoom - 1;
            return baseZoom;
        }

        map = L.map('map', { zoomControl: window.innerWidth > 768 }).setView(RADAR_CONFIG.mendanha.center, getInitialZoom());
        currentTileLayer = MAP_LAYERS.dark;
        currentTileLayer.addTo(map);
        
        // Adicionar controle de zoom em posi√ß√£o diferente no mobile
        if (window.innerWidth <= 768) {
            L.control.zoom({ position: 'topright' }).addTo(map);
        }
        
        radarMarker = L.marker(RADAR_CONFIG.mendanha.markerPos).bindPopup(RADAR_CONFIG.mendanha.markerName);
        arrowsLayer = L.layerGroup().addTo(map);

        async function createAllOverlays(radar) {
            const config = RADAR_CONFIG[radar];
            
            frameOverlays.forEach(overlay => {
                if (overlay) map.removeLayer(overlay);
            });
            frameOverlays = [];
            imagesReady = false;
            
            document.getElementById('loadingOverlay').style.display = 'block';
            document.getElementById('loadingText').textContent = 'Carregando imagens... 0/' + frames.length;
            
            let loadedCount = 0;
            
            // Adicionar par√¢metro de filtro apenas para Mendanha
            const filterParam = (filterRainOnly && radar === 'mendanha') ? '?filter=rain' : '';
            
            for (let i = 0; i < frames.length; i++) {
                const filename = frames[i];
                const url = config.apiFrame + filename + filterParam;
                
                await new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => {
                        loadedCount++;
                        document.getElementById('loadingText').textContent = 'Carregando imagens... ' + loadedCount + '/' + frames.length;
                        resolve();
                    };
                    img.onerror = () => {
                        loadedCount++;
                        resolve();
                    };
                    img.src = url;
                });
                
                const overlay = L.imageOverlay(url, config.bounds, { opacity: 0 });
                overlay.addTo(map);
                frameOverlays.push(overlay);
            }
            
            if (frameOverlays.length > 0) {
                frameOverlays[0].setOpacity(currentOpacity);
            }
            
            imagesReady = true;
            document.getElementById('loadingOverlay').style.display = 'none';
        }

        function showFrame(index) {
            if (frames.length === 0 || !imagesReady || frameOverlays.length === 0) return;
            
            if (frameOverlays[currentFrame]) {
                frameOverlays[currentFrame].setOpacity(0);
            }
            
            currentFrame = index;
            
            if (frameOverlays[currentFrame]) {
                frameOverlays[currentFrame].setOpacity(currentOpacity);
            }
            
            const frameNum = (index + 1) + '/' + frames.length;
            document.getElementById('frameCounter').textContent = frameNum;
            document.getElementById('timelineBar').style.width = ((index + 1) / frames.length * 100) + '%';
            
            const filename = frames[index];
            
            if (currentRadar === 'mendanha') {
                document.getElementById('currentFrameNum').textContent = frameNum;
                const match = filename.match(/MDN-(\d{4})(\d{2})(\d{2})-(\d{2})(\d{2})/);
                if (match) {
                    document.getElementById('timeDisplay').textContent = match[3] + '/' + match[2] + '/' + match[1] + ', ' + match[4] + ':' + match[5] + ':00';
                }
            } else if (currentRadar === 'sumare') {
                document.getElementById('sumareFrameNum').textContent = frameNum;
                const now = new Date();
                document.getElementById('timeDisplay').textContent = now.toLocaleDateString('pt-BR') + ', ' + now.toLocaleTimeString('pt-BR');
            }
            
            drawArrowsForFrame(index);
        }

        // Download GIF
        document.getElementById('downloadGif').onclick = async function() {
            const btn = this;
            const originalText = btn.innerHTML;
            
            btn.disabled = true;
            btn.innerHTML = '<span class="icon">‚è≥</span><span>Gerando...</span>';
            
            try {
                const response = await fetch(`/api/export/gif/${currentRadar}`);
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Erro ao gerar GIF');
                }
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `radar_${currentRadar}_${new Date().toISOString().slice(0,19).replace(/[:-]/g,'')}.gif`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
                
                btn.innerHTML = '<span class="icon">‚úÖ</span><span>Conclu√≠do!</span>';
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                }, 2000);
            } catch (error) {
                alert('Erro: ' + error.message);
                btn.innerHTML = originalText;
                btn.disabled = false;
            }
        };

        // Fun√ß√£o para trocar radar (usada por ambos seletores)
        function switchRadar(radar) {
            // Atualizar todos os bot√µes de radar
            document.querySelectorAll('.radar-btn').forEach(b => {
                b.classList.toggle('active', b.dataset.radar === radar);
            });
            
            currentRadar = radar;
            
            stopPlayback();
            arrowsLayer.clearLayers();
            
            // Fechar sidebar no mobile ap√≥s selecionar
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('open');
                document.getElementById('sidebarToggle').classList.remove('active');
            }
            
            if (currentRadar === 'niteroi') {
                document.getElementById('map').style.display = 'none';
                document.getElementById('externalRadar').style.display = 'none';
                document.getElementById('niteroiContainer').style.display = 'block';
                document.getElementById('niteroiRadar').src = 'https://radar.niteroi.rj.gov.br/';
                document.getElementById('controls').style.display = 'none';

                document.getElementById('radarTitle').textContent = 'Radar Niter√≥i';
                document.getElementById('mendanhaInfo').style.display = 'none';
                document.getElementById('sumareInfo').style.display = 'none';
                document.getElementById('niteroiInfo').style.display = 'block';
                document.getElementById('mapCard').style.display = 'none';
                document.getElementById('configCard').style.display = 'none';
                document.getElementById('nucleiCard').style.display = 'none';
                document.getElementById('exportCard').style.display = 'none';
                document.getElementById('legendOverlay').style.display = 'none';
                document.getElementById('delayAlert').style.display = 'none';

                // Esconder seletor de mapa no mobile quando Niter√≥i
                document.querySelector('.mobile-map-selector').style.display = 'none';
            } else {
                document.getElementById('map').style.display = 'block';
                document.getElementById('externalRadar').style.display = 'none';
                document.getElementById('niteroiContainer').style.display = 'none';
                document.getElementById('niteroiRadar').src = '';
                document.getElementById('controls').style.display = 'flex';
                document.getElementById('mapCard').style.display = 'block';
                document.getElementById('configCard').style.display = 'block';
                document.getElementById('nucleiCard').style.display = 'block';
                document.getElementById('exportCard').style.display = 'block';
                document.getElementById('legendOverlay').style.display = 'block';
                
                // Mostrar seletor de mapa no mobile
                document.querySelector('.mobile-map-selector').style.display = 'flex';
                
                const config = RADAR_CONFIG[currentRadar];
                map.setView(config.center, getInitialZoom());
                
                radarMarker.setLatLng(config.markerPos);
                radarMarker.setPopupContent(config.markerName);
                
                if (currentRadar === 'mendanha') {
                    document.getElementById('radarTitle').textContent = 'Radar Mendanha';
                    document.getElementById('mendanhaInfo').style.display = 'block';
                    document.getElementById('sumareInfo').style.display = 'none';
                    document.getElementById('niteroiInfo').style.display = 'none';
                } else if (currentRadar === 'sumare') {
                    document.getElementById('radarTitle').textContent = 'Radar Sumar√©';
                    document.getElementById('mendanhaInfo').style.display = 'none';
                    document.getElementById('sumareInfo').style.display = 'block';
                    document.getElementById('niteroiInfo').style.display = 'none';
                }
                
                // Atualizar visibilidade do filtro de chuva
                updateFilterVisibility();
                
                loadFrames(currentRadar);
                map.invalidateSize();
            }
        }

        // Fun√ß√£o para trocar mapa (usada por ambos seletores)
        function switchMap(mapType) {
            // Atualizar todos os bot√µes de mapa
            document.querySelectorAll('.map-btn').forEach(b => {
                b.classList.toggle('active', b.dataset.map === mapType);
            });
            
            map.removeLayer(currentTileLayer);
            currentTileLayer = MAP_LAYERS[mapType];
            currentTileLayer.addTo(map);
        }

        // Seletor de radar (header e mobile)
        document.querySelectorAll('.radar-btn').forEach(btn => {
            btn.onclick = function() {
                switchRadar(this.dataset.radar);
            };
        });

        // Seletor de mapa (sidebar e mobile)
        document.querySelectorAll('.map-btn').forEach(btn => {
            btn.onclick = function() {
                switchMap(this.dataset.map);
            };
        });

        document.getElementById('toggleMarker').onclick = function() {
            this.classList.toggle('active');
            this.classList.contains('active') ? radarMarker.addTo(map) : map.removeLayer(radarMarker);
        };

        document.getElementById('toggleArrows').onclick = function() {
            this.classList.toggle('active');
            showArrows = this.classList.contains('active');
            if (showArrows) {
                drawArrowsForFrame(currentFrame);
            } else {
                arrowsLayer.clearLayers();
            }
        };

        document.getElementById('toggleOpacity').onclick = function() {
            this.classList.toggle('active');
            currentOpacity = this.classList.contains('active') ? HIGH_OPACITY : BASE_OPACITY;
            if (frameOverlays[currentFrame]) {
                frameOverlays[currentFrame].setOpacity(currentOpacity);
            }
        };

        // Toggle filtro de chuva (s√≥ Mendanha)
        document.getElementById('toggleFilterRain').onclick = async function() {
            this.classList.toggle('active');
            filterRainOnly = this.classList.contains('active');
            
            // Recarregar imagens se estiver no Mendanha
            if (currentRadar === 'mendanha' && frames.length > 0) {
                stopPlayback();
                await createAllOverlays('mendanha');
                showFrame(0);
                startPlayback();
                
                // Reanalisar se filtro ativo
                if (filterRainOnly) {
                    analyzeAllFrames();
                }
            }
        };
        
        // Mostrar/esconder op√ß√£o de filtro baseado no radar
        function updateFilterVisibility() {
            const filterRow = document.getElementById('filterRainRow');
            if (filterRow) {
                filterRow.style.display = (currentRadar === 'mendanha') ? 'flex' : 'none';
            }
        }

        // Atualizar alerta de atraso do radar
        function updateDelayAlert(delayMinutes) {
            const alertEl = document.getElementById('delayAlert');
            const delayTimeEl = document.getElementById('delayTime');

            if (currentRadar !== 'mendanha' || delayMinutes === null || delayMinutes < DELAY_WARNING_THRESHOLD) {
                alertEl.style.display = 'none';
                return;
            }

            delayTimeEl.textContent = delayMinutes;
            alertEl.style.display = 'flex';

            // Cr√≠tico (vermelho) se > 60 min, warning (laranja) se > 30 min
            if (delayMinutes >= DELAY_CRITICAL_THRESHOLD) {
                alertEl.classList.remove('warning');
            } else {
                alertEl.classList.add('warning');
            }
        }

        function detectNuclei(imageData, width, height) {
            const data = imageData.data;
            const visited = new Set();
            const nuclei = [];

            function isRainPixel(r, g, b, a) {
                if (a < 100) return false;
                
                // Se filtro de chuva ativo, ignorar pixels azuis (umidade)
                if (filterRainOnly) {
                    // Ignorar azul/ciano (umidade)
                    if (b > 100 && b > r && b >= g) return false;
                    if (b > 150 && g > 150 && r < 100) return false;
                }
                
                if (g > 200 && r < 100 && b < 100) return { intensity: 1 };  // Verde claro
                if (g > 100 && g < 200 && r < 100 && b < 100) return { intensity: 2 };  // Verde escuro
                if (r > 200 && g > 200 && b < 100) return { intensity: 3 };  // Amarelo
                if (r > 200 && g > 100 && g < 200 && b < 100) return { intensity: 4 };  // Laranja
                if (r > 200 && g < 100 && b < 100) return { intensity: 5 };  // Vermelho
                if (r > 200 && b > 200 && g < 100) return { intensity: 6 };  // Magenta
                
                // Ciano/azul claro (s√≥ se filtro desativado)
                if (!filterRainOnly && b > 150 && g > 150 && r < 100) return { intensity: 1 };
                
                return false;
            }

            function floodFill(startX, startY) {
                const cluster = [];
                const stack = [[startX, startY]];
                let totalIntensity = 0;
                while (stack.length > 0) {
                    const [x, y] = stack.pop();
                    const key = `${x},${y}`;
                    if (visited.has(key) || x < 0 || x >= width || y < 0 || y >= height) continue;
                    const idx = (y * width + x) * 4;
                    const pixel = isRainPixel(data[idx], data[idx+1], data[idx+2], data[idx+3]);
                    if (!pixel) continue;
                    visited.add(key);
                    cluster.push({x, y});
                    totalIntensity += pixel.intensity;
                    stack.push([x+1, y], [x-1, y], [x, y+1], [x, y-1]);
                }
                return { cluster, avgIntensity: cluster.length > 0 ? totalIntensity / cluster.length : 0 };
            }

            for (let y = 0; y < height; y += 4) {
                for (let x = 0; x < width; x += 4) {
                    const key = `${x},${y}`;
                    if (visited.has(key)) continue;
                    const idx = (y * width + x) * 4;
                    if (isRainPixel(data[idx], data[idx+1], data[idx+2], data[idx+3])) {
                        const { cluster, avgIntensity } = floodFill(x, y);
                        if (cluster.length >= 80) {
                            let sumX = 0, sumY = 0;
                            cluster.forEach(p => { sumX += p.x; sumY += p.y; });
                            nuclei.push({ x: sumX / cluster.length, y: sumY / cluster.length, size: cluster.length, intensity: avgIntensity });
                        }
                    }
                }
            }
            return nuclei;
        }

        function pixelToLatLng(x, y, imgWidth, imgHeight, bounds) {
            const boundsHeight = bounds[1][0] - bounds[0][0];
            const boundsWidth = bounds[1][1] - bounds[0][1];
            const lat = bounds[1][0] - (y / imgHeight) * Math.abs(boundsHeight);
            const lng = bounds[0][1] + (x / imgWidth) * boundsWidth;
            return [lat, lng];
        }

        function getCardinalDirection(angle) {
            const directions = ['E', 'NE', 'N', 'NW', 'W', 'SW', 'S', 'SE'];
            const idx = Math.round(((angle + 180 + 22.5) % 360) / 45) % 8;
            return directions[idx];
        }

        async function analyzeFrames(radar) {
            const config = RADAR_CONFIG[radar];
            const framesData = allFramesData[radar];
            
            if (frames.length < 2) return;
            
            const canvas = document.getElementById('analysisCanvas');
            const ctx = canvas.getContext('2d');
            framesData.length = 0;

            document.getElementById('nucleusList').innerHTML = '<div class="loading">Analisando n√∫cleos... 0/' + frames.length + '</div>';

            for (let i = 0; i < frames.length; i++) {
                const img = new Image();
                img.crossOrigin = 'anonymous';
                
                await new Promise((resolve) => {
                    img.onload = () => {
                        canvas.width = img.width;
                        canvas.height = img.height;
                        ctx.drawImage(img, 0, 0);
                        try {
                            const imageData = ctx.getImageData(0, 0, img.width, img.height);
                            const nuclei = detectNuclei(imageData, img.width, img.height);
                            framesData.push({ frame: i, nuclei, width: img.width, height: img.height });
                        } catch(e) { 
                            framesData.push({ frame: i, nuclei: [], width: 1024, height: 1024 });
                        }
                        document.getElementById('nucleusList').innerHTML = '<div class="loading">Analisando n√∫cleos... ' + (i+1) + '/' + frames.length + '</div>';
                        resolve();
                    };
                    img.onerror = () => {
                        framesData.push({ frame: i, nuclei: [], width: 1024, height: 1024 });
                        resolve();
                    };
                    img.src = config.apiFrame + frames[i];
                });
            }
            
            calculateMovements(radar);
            drawArrowsForFrame(currentFrame);
        }

        function calculateMovements(radar) {
            const framesData = allFramesData[radar];
            
            for (let i = 0; i < framesData.length - 1; i++) {
                const current = framesData[i];
                const next = framesData[i + 1];
                
                current.movements = [];
                
                current.nuclei.forEach(nucleus => {
                    let bestMatch = null, bestDist = Infinity;
                    
                    next.nuclei.forEach(nextNucleus => {
                        const dist = Math.hypot(nucleus.x - nextNucleus.x, nucleus.y - nextNucleus.y);
                        if (dist < bestDist && dist < 150) {
                            bestDist = dist;
                            bestMatch = nextNucleus;
                        }
                    });
                    
                    if (bestMatch) {
                        const dx = bestMatch.x - nucleus.x;
                        const dy = bestMatch.y - nucleus.y;
                        const speed = Math.hypot(dx, dy);
                        const angle = Math.atan2(dy, dx) * 180 / Math.PI;
                        
                        if (speed > 2) {
                            current.movements.push({
                                x: nucleus.x,
                                y: nucleus.y,
                                dx, dy, speed, angle,
                                intensity: nucleus.intensity,
                                size: nucleus.size
                            });
                        }
                    }
                });
            }
        }

        function drawArrowsForFrame(frameIndex) {
            arrowsLayer.clearLayers();
            
            const framesData = allFramesData[currentRadar];
            const config = RADAR_CONFIG[currentRadar];
            
            if (!showArrows || !framesData || framesData.length === 0) return;
            
            const frameData = framesData[frameIndex];
            if (!frameData || !frameData.movements) return;
            
            const movements = frameData.movements;
            const intensityColors = ['#00ff00', '#008800', '#ffff00', '#ff9900', '#ff0000', '#ff00ff'];
            const intensityNames = ['Fraco', 'Leve', 'Moderado', 'Forte', 'Muito Forte', 'Extremo'];
            
            if (currentRadar === 'mendanha') {
                document.getElementById('nucleiCount').textContent = movements.length;
            } else if (currentRadar === 'sumare') {
                document.getElementById('sumareNucleiCount').textContent = movements.length;
            }
            
            const listEl = document.getElementById('nucleusList');
            listEl.innerHTML = '';

            movements.forEach((m, i) => {
                const latlng = pixelToLatLng(m.x, m.y, frameData.width, frameData.height, config.bounds);
                const intIdx = Math.min(Math.floor(m.intensity) - 1, 5);
                const color = intensityColors[Math.max(0, intIdx)];
                const name = intensityNames[Math.max(0, intIdx)];
                const svgAngle = m.angle + 90;

                const arrowIcon = createArrowIcon(svgAngle);
                L.marker(latlng, { icon: arrowIcon }).addTo(arrowsLayer);

                const speedKmh = Math.round(m.speed * 2.5);
                const dir = getCardinalDirection(m.angle);

                listEl.innerHTML += `<div class="nucleus-item">
                    <div class="nucleus-icon" style="background:${color}">‚òÅÔ∏è</div>
                    <div class="nucleus-info">
                        <div class="nucleus-name">N√∫cleo ${i + 1} - ${name}</div>
                        <div class="nucleus-dir">‚Üí ${dir}</div>
                    </div>
                    <div class="nucleus-speed">~${speedKmh} km/h</div>
                </div>`;
            });

            if (movements.length === 0) {
                listEl.innerHTML = '<div style="color: var(--text-secondary); font-size: 0.8rem;">Nenhum n√∫cleo em movimento</div>';
            }
        }

        async function loadFrames(radar) {
            const config = RADAR_CONFIG[radar];

            try {
                const res = await fetch(config.apiFrames);
                const data = await res.json();
                frames = data.frames || [];

                if (radar === 'mendanha') {
                    document.getElementById('frameCount').textContent = frames.length;
                    // Atualizar alerta de atraso
                    currentDelayMinutes = data.delay_minutes;
                    updateDelayAlert(data.delay_minutes);
                } else {
                    document.getElementById('sumareFrameCount').textContent = frames.length;
                    // Esconder alerta quando n√£o √© Mendanha
                    updateDelayAlert(null);
                }

                currentFrame = 0;

                if (frames.length > 0) {
                    await createAllOverlays(radar);
                    showFrame(0);
                    await analyzeFrames(radar);
                    startPlayback();
                }
            } catch (e) {
                console.error('Erro ao carregar frames:', e);
            }
        }

        function startPlayback() {
            if (isPlaying || !imagesReady) return;
            isPlaying = true;
            document.getElementById('playBtn').textContent = '‚è∏';
            document.getElementById('playBtn').classList.add('playing');
            playInterval = setInterval(() => {
                const nextFrame = (currentFrame + 1) % frames.length;
                showFrame(nextFrame);
            }, ANIMATION_SPEED);
        }

        function stopPlayback() {
            if (!isPlaying) return;
            isPlaying = false;
            document.getElementById('playBtn').textContent = '‚ñ∂';
            document.getElementById('playBtn').classList.remove('playing');
            clearInterval(playInterval);
        }

        document.getElementById('playBtn').onclick = function() {
            if (isPlaying) stopPlayback();
            else startPlayback();
        };

        document.getElementById('prevBtn').onclick = () => { 
            stopPlayback();
            const prevFrame = (currentFrame - 1 + frames.length) % frames.length;
            showFrame(prevFrame);
        };
        
        document.getElementById('nextBtn').onclick = () => { 
            stopPlayback();
            const nextFrame = (currentFrame + 1) % frames.length;
            showFrame(nextFrame);
        };
        
        document.getElementById('timeline').onclick = function(e) { 
            const newFrame = Math.floor((e.offsetX / this.offsetWidth) * frames.length);
            showFrame(newFrame);
        };

        // Suporte a touch na timeline
        document.getElementById('timeline').addEventListener('touchstart', function(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = this.getBoundingClientRect();
            const x = touch.clientX - rect.left;
            const newFrame = Math.floor((x / rect.width) * frames.length);
            showFrame(Math.max(0, Math.min(newFrame, frames.length - 1)));
        });

        // Resize handler
        window.addEventListener('resize', () => {
            setTimeout(() => map.invalidateSize(), 100);
        });

        // Inicializa√ß√£o inteligente: verificar se Mendanha est√° atualizado
        async function initRadar() {
            try {
                // Verificar status do Mendanha primeiro
                const res = await fetch('/api/frames/mendanha');
                const data = await res.json();
                const delayMinutes = data.delay_minutes;

                if (delayMinutes !== null && delayMinutes >= DELAY_WARNING_THRESHOLD) {
                    // Mendanha desatualizado - iniciar com Sumar√©
                    console.log(`Mendanha desatualizado (${delayMinutes} min), iniciando com Sumar√©`);
                    switchRadar('sumare');
                } else {
                    // Mendanha OK - iniciar normalmente
                    loadFrames('mendanha');
                    updateFilterVisibility();
                }
            } catch (e) {
                // Em caso de erro, tentar Mendanha mesmo assim
                console.error('Erro ao verificar status:', e);
                loadFrames('mendanha');
                updateFilterVisibility();
            }
        }

        // Iniciar
        initRadar();

        // Auto-refresh a cada 2 minutos
        setInterval(() => {
            if (currentRadar === 'mendanha' || currentRadar === 'sumare') {
                loadFrames(currentRadar);
            }
        }, 120000);
    </script>
</body>
</html>