<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>Mosaico - Radar Nowcast</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>
        /* Vari√°veis de Tema */
        :root {
            --bg-primary: #0f1419;
            --bg-secondary: #1a1f26;
            --bg-tertiary: #242b33;
            --border-color: #2f3942;
            --text-primary: #ffffff;
            --text-secondary: #8899a6;
            --accent-color: #00d4ff;
            --success-color: #00ff88;
            --controls-bg: rgba(50, 55, 65, 0.95);
        }
        
        /* Modo Claro - Paleta Oficial Prefeitura Rio */
        body.light-mode {
            --bg-primary: #eceded;
            --bg-secondary: #ffffff;
            --bg-tertiary: #e0e0e0;
            --border-color: #c5c5c5;
            --text-primary: #13335a;
            --text-secondary: #4a6a8a;
            --accent-color: #13335a;
            --success-color: #00aa55;
            --controls-bg: rgba(255, 255, 255, 0.95);
        }
        
        /* Corre√ß√µes espec√≠ficas para modo claro */
        body.light-mode .header-btn {
            color: #13335a;
            border-color: #c5c5c5;
        }
        body.light-mode .header-btn:hover {
            background: #e0e0e0;
            border-color: #13335a;
        }
        body.light-mode .layout-btn {
            background: #ffffff;
            border-color: #c5c5c5;
        }
        body.light-mode .layout-btn svg rect,
        body.light-mode .layout-btn svg path {
            fill: #13335a;
        }
        body.light-mode .layout-btn.active {
            background: #13335a;
        }
        body.light-mode .layout-btn.active svg rect,
        body.light-mode .layout-btn.active svg path {
            fill: #ffffff;
        }
        body.light-mode .mobile-tab {
            color: #13335a;
            background: #ffffff;
        }
        body.light-mode .mobile-tab.active {
            background: #13335a;
            color: #ffffff;
        }
        body.light-mode .theme-toggle {
            color: #13335a;
            border-color: #c5c5c5;
        }
        body.light-mode .panel-player .ctrl-btn:hover {
            background: rgba(0, 0, 0, 0.1);
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', sans-serif; 
            background: var(--bg-primary); 
            color: var(--text-primary); 
            height: 100vh; 
            overflow: hidden;
            transition: background 0.3s ease, color 0.3s ease;
        }
        
        header { 
            height: 50px; 
            display: flex; 
            align-items: center; 
            justify-content: space-between; 
            padding: 0 20px; 
            background: var(--bg-secondary); 
            border-bottom: 1px solid var(--border-color);
            transition: background 0.3s ease, border-color 0.3s ease;
        }
        .logo { display: flex; align-items: center; }
        .logo img { height: 32px; }
        
        .header-controls { display: flex; align-items: center; gap: 10px; }
        .header-btn { padding: 6px 12px; border: 1px solid var(--border-color); background: transparent; color: var(--text-secondary); font-size: 0.8rem; border-radius: 6px; cursor: pointer; transition: all 0.2s; display: flex; align-items: center; gap: 6px; }
        .header-btn:hover { border-color: var(--accent-color); color: var(--text-primary); }
        .header-btn.active { background: var(--accent-color); color: #000; border-color: var(--accent-color); }
        
        .theme-toggle {
            padding: 6px 12px;
            border: 1px solid var(--border-color);
            background: transparent;
            color: var(--text-secondary);
            font-size: 1rem;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .theme-toggle:hover { border-color: var(--accent-color); color: var(--text-primary); }
        
        .layout-selector { display: flex; gap: 4px; background: var(--bg-primary); padding: 4px; border-radius: 8px; transition: background 0.3s ease; }
        .layout-btn { width: 36px; height: 28px; border: 1px solid var(--border-color); background: var(--bg-secondary); border-radius: 4px; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .layout-btn:hover { border-color: var(--accent-color); }
        .layout-btn.active { background: var(--accent-color); border-color: var(--accent-color); }
        .layout-btn svg { width: 20px; height: 16px; }
        .layout-btn.active svg rect, .layout-btn.active svg path { fill: #000; }
        .layout-btn svg rect, .layout-btn svg path { fill: var(--text-secondary); }
        
        /* Tabs para mobile */
        .mobile-tabs {
            display: none;
            background: var(--bg-secondary);
            padding: 8px;
            gap: 4px;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.3s ease, border-color 0.3s ease;
        }
        .mobile-tab {
            flex: 1;
            padding: 12px 8px;
            border: none;
            background: var(--bg-primary);
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .mobile-tab.active {
            background: var(--accent-color);
            color: #000;
        }
        
        .mosaic-container { 
            height: calc(100vh - 50px); 
            display: grid; 
            gap: 4px; 
            padding: 4px; 
            background: var(--bg-primary);
            transition: background 0.3s ease;
        }
        
        .mosaic-container.layout-1 { grid-template-columns: 1fr 1fr 1fr; }
        
        .mosaic-container.layout-2 { 
            grid-template-columns: 1fr 1fr; 
            grid-template-rows: 2fr 1fr; 
        }
        .mosaic-container.layout-2 .panel:first-child { grid-column: 1 / -1; }
        
        .mosaic-container.layout-3 { 
            grid-template-columns: 1fr 1fr; 
            grid-template-rows: 1fr 2fr; 
        }
        .mosaic-container.layout-3 .panel:nth-child(3) { grid-column: 1 / -1; }
        
        .mosaic-container.layout-4 { 
            grid-template-columns: 2fr 1fr; 
            grid-template-rows: 1fr 1fr; 
        }
        .mosaic-container.layout-4 .panel:first-child { grid-row: 1 / -1; }
        
        .panel { 
            background: var(--bg-secondary); 
            border-radius: 8px; 
            overflow: hidden; 
            position: relative;
            display: flex;
            flex-direction: column;
            border: 1px solid var(--border-color);
            transition: background 0.3s ease, border-color 0.3s ease;
        }
        
        .panel-header { 
            height: 36px; 
            background: var(--bg-tertiary); 
            display: flex; 
            align-items: center; 
            justify-content: space-between;
            padding: 0 12px;
            border-bottom: 1px solid var(--border-color);
            transition: background 0.3s ease, border-color 0.3s ease;
        }
        .panel-title { font-size: 0.85rem; font-weight: 600; display: flex; align-items: center; gap: 8px; }
        .panel-badge { padding: 2px 8px; background: var(--accent-color); color: #000; border-radius: 4px; font-size: 0.7rem; font-weight: 600; }
        
        .panel-content { flex: 1; position: relative; }
        .panel-map { width: 100%; height: 100%; }
        .panel-iframe { width: 100%; height: 100%; border: none; }
        
        /* Iframe recortado para Niter√≥i */
        .niteroi-iframe-container {
            position: relative;
            width: 100%;
            height: 100%;
            overflow: hidden;
        }
        .niteroi-iframe-container iframe {
            position: absolute;
            top: -119px;
            left: -5px;
            width: calc(100% + 10px);
            height: calc(100% + 217px);
            border: none;
        }
        
        .panel-player {
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background: var(--controls-bg);
            border-radius: 6px;
            z-index: 1000;
            border: 1px solid var(--border-color);
            transition: background 0.3s ease, border-color 0.3s ease;
        }
        .panel-player .ctrl-btn { 
            width: 28px; height: 28px; border: none; background: transparent; 
            color: var(--text-primary); cursor: pointer; font-size: 12px; border-radius: 4px; 
        }
        .panel-player .ctrl-btn:hover { background: rgba(255,255,255,0.1); }
        .panel-player .time-display { font-size: 12px; color: var(--text-primary); min-width: 90px; text-align: center; }
        .panel-player .frame-counter { font-size: 10px; color: var(--text-secondary); }
        
        .panel-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--controls-bg);
            padding: 15px 20px;
            border-radius: 8px;
            z-index: 2000;
            text-align: center;
            font-size: 12px;
            border: 1px solid var(--border-color);
        }
        .panel-spinner {
            width: 24px;
            height: 24px;
            border: 2px solid var(--border-color);
            border-top-color: var(--accent-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 8px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* ============================================ */
        /* RESPONSIVO - TABLET (768px - 1024px) */
        /* ============================================ */
        @media (max-width: 1024px) {
            .mosaic-container.layout-1 { 
                grid-template-columns: 1fr 1fr;
                grid-template-rows: 1fr 1fr;
            }
            .mosaic-container.layout-1 .panel:nth-child(3) { 
                grid-column: 1 / -1; 
            }
            
            .layout-btn { width: 32px; height: 26px; }
            .header-btn span:last-child { display: none; }
        }

        /* ============================================ */
        /* RESPONSIVO - MOBILE (at√© 768px) */
        /* ============================================ */
        @media (max-width: 768px) {
            header { padding: 0 12px; height: 45px; }
            .logo img { height: 28px; }
            
            .layout-selector { display: none; }
            
            .mobile-tabs { display: flex; }
            
            .mosaic-container {
                height: calc(100vh - 45px - 56px);
                grid-template-columns: 1fr !important;
                grid-template-rows: 1fr !important;
                padding: 0;
                gap: 0;
            }
            
            .panel {
                display: none !important;
                border-radius: 0;
            }
            .panel.active-mobile {
                display: flex !important;
            }
            
            .panel-header { height: 40px; padding: 0 12px; }
            .panel-title { font-size: 0.9rem; }
            .panel-badge { padding: 3px 10px; font-size: 0.75rem; }
            
            .panel-player {
                bottom: 15px;
                padding: 10px 16px;
                gap: 10px;
            }
            .panel-player .ctrl-btn { width: 36px; height: 36px; font-size: 16px; }
            .panel-player .time-display { font-size: 14px; min-width: 110px; }
            .panel-player .frame-counter { font-size: 12px; }
        }

        /* ============================================ */
        /* RESPONSIVO - MOBILE PEQUENO (at√© 480px) */
        /* ============================================ */
        @media (max-width: 480px) {
            header { padding: 0 8px; height: 42px; }
            .logo img { height: 24px; }
            .header-btn { padding: 5px 10px; font-size: 0.75rem; }
            
            .mobile-tabs { padding: 6px; gap: 4px; }
            .mobile-tab { padding: 10px 6px; font-size: 0.85rem; }
            
            .mosaic-container {
                height: calc(100vh - 42px - 50px);
            }
            
            .panel-header { height: 36px; }
            
            .panel-player {
                bottom: 10px;
                padding: 8px 12px;
                gap: 6px;
                width: calc(100% - 20px);
                max-width: 350px;
            }
            .panel-player .ctrl-btn { width: 40px; height: 40px; font-size: 18px; }
            .panel-player .time-display { flex: 1; font-size: 14px; }
        }

        /* ============================================ */
        /* LANDSCAPE MOBILE */
        /* ============================================ */
        @media (max-height: 500px) and (orientation: landscape) {
            header { height: 40px; }
            .logo img { height: 24px; }
            
            .mobile-tabs { padding: 4px; }
            .mobile-tab { padding: 8px 6px; font-size: 0.8rem; }
            
            .mosaic-container {
                height: calc(100vh - 40px - 42px);
            }
            
            .panel-header { height: 30px; }
            .panel-player {
                bottom: 8px;
                padding: 6px 12px;
            }
            .panel-player .ctrl-btn { width: 32px; height: 32px; font-size: 14px; }
            .panel-player .time-display { font-size: 12px; }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <img src="logo-cor.png" alt="Centro de Opera√ß√µes Rio">
        </div>
        <div class="header-controls">
            <div class="layout-selector">
                <button class="layout-btn active" data-layout="1" title="3 colunas">
                    <svg viewBox="0 0 24 18"><rect x="1" y="1" width="6" height="16" rx="1"/><rect x="9" y="1" width="6" height="16" rx="1"/><rect x="17" y="1" width="6" height="16" rx="1"/></svg>
                </button>
                <button class="layout-btn" data-layout="2" title="1 grande + 2 embaixo">
                    <svg viewBox="0 0 24 18"><rect x="1" y="1" width="22" height="10" rx="1"/><rect x="1" y="13" width="10" height="4" rx="1"/><rect x="13" y="13" width="10" height="4" rx="1"/></svg>
                </button>
                <button class="layout-btn" data-layout="3" title="2 em cima + 1 grande">
                    <svg viewBox="0 0 24 18"><rect x="1" y="1" width="10" height="4" rx="1"/><rect x="13" y="1" width="10" height="4" rx="1"/><rect x="1" y="7" width="22" height="10" rx="1"/></svg>
                </button>
                <button class="layout-btn" data-layout="4" title="1 grande esquerda + 2 direita">
                    <svg viewBox="0 0 24 18"><rect x="1" y="1" width="14" height="16" rx="1"/><rect x="17" y="1" width="6" height="7" rx="1"/><rect x="17" y="10" width="6" height="7" rx="1"/></svg>
                </button>
            </div>
            <button class="theme-toggle" id="themeToggle" title="Alternar tema">
                <span id="themeIcon">‚òÄÔ∏è</span>
            </button>
            <button class="header-btn" onclick="window.location.href='index.html'">
                <span>‚Üê</span> <span>Voltar</span>
            </button>
        </div>
    </header>
    
    <!-- Tabs para mobile -->
    <div class="mobile-tabs" id="mobileTabs">
        <button class="mobile-tab active" data-panel="mendanha">Mendanha</button>
        <button class="mobile-tab" data-panel="sumare">Sumar√©</button>
        <button class="mobile-tab" data-panel="niteroi">Niter√≥i</button>
    </div>
    
    <div class="mosaic-container layout-1" id="mosaicContainer">
        <div class="panel active-mobile" data-radar="mendanha">
            <div class="panel-header">
                <div class="panel-title">
                    <span class="panel-badge">Mendanha</span>
                    <span style="font-size: 0.7rem; color: var(--text-secondary);">INEA</span>
                </div>
            </div>
            <div class="panel-content">
                <div id="map-mendanha" class="panel-map"></div>
                <div class="panel-loading" id="loading-mendanha">
                    <div class="panel-spinner"></div>
                    <div>Carregando...</div>
                </div>
                <div class="panel-player" id="player-mendanha">
                    <button class="ctrl-btn" data-action="prev">‚è™</button>
                    <button class="ctrl-btn" data-action="play">‚ñ∂</button>
                    <button class="ctrl-btn" data-action="next">‚è©</button>
                    <span class="time-display">Carregando...</span>
                    <span class="frame-counter">0/0</span>
                </div>
            </div>
        </div>
        
        <div class="panel" data-radar="sumare">
            <div class="panel-header">
                <div class="panel-title">
                    <span class="panel-badge" style="background: #ff9900;">Sumar√©</span>
                    <span style="font-size: 0.7rem; color: var(--text-secondary);">AlertaRio</span>
                </div>
            </div>
            <div class="panel-content">
                <div id="map-sumare" class="panel-map"></div>
                <div class="panel-loading" id="loading-sumare">
                    <div class="panel-spinner"></div>
                    <div>Carregando...</div>
                </div>
                <div class="panel-player" id="player-sumare">
                    <button class="ctrl-btn" data-action="prev">‚è™</button>
                    <button class="ctrl-btn" data-action="play">‚ñ∂</button>
                    <button class="ctrl-btn" data-action="next">‚è©</button>
                    <span class="time-display">Carregando...</span>
                    <span class="frame-counter">0/0</span>
                </div>
            </div>
        </div>
        
        <div class="panel" data-radar="niteroi">
            <div class="panel-header">
                <div class="panel-title">
                    <span class="panel-badge" style="background: #00ff88;">Niter√≥i</span>
                    <span style="font-size: 0.7rem; color: var(--text-secondary);">Defesa Civil</span>
                </div>
            </div>
            <div class="panel-content">
                <div class="niteroi-iframe-container">
                    <iframe class="panel-iframe" id="iframe-niteroi" src="https://radar.niteroi.rj.gov.br/"></iframe>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const ANIMATION_SPEED = 650;
        const BASE_OPACITY = 0.7;
        
        // Theme toggle (modo escuro/claro)
        let isDarkMode = localStorage.getItem('theme') !== 'light';
        
        function applyTheme() {
            document.body.classList.toggle('light-mode', !isDarkMode);
            document.getElementById('themeIcon').textContent = isDarkMode ? '‚òÄÔ∏è' : 'üåô';
            
            // Trocar logo baseado no tema
            const logo = document.querySelector('.logo img');
            if (logo) {
                logo.src = isDarkMode ? 'logo-cor.png' : 'logo-cor-azul.png';
            }
            
            // Trocar mapas do mosaico
            if (typeof switchMosaicMaps === 'function' && radarState.mendanha.map) {
                switchMosaicMaps(!isDarkMode);
            }
        }
        
        document.getElementById('themeToggle').onclick = function() {
            isDarkMode = !isDarkMode;
            localStorage.setItem('theme', isDarkMode ? 'dark' : 'light');
            applyTheme();
        };
        
        // Aplicar tema salvo ao carregar
        applyTheme();
        
        const RADAR_CONFIG = {
            mendanha: {
                bounds: [[-24.8, -46.5], [-20.8, -40.5]],
                center: [-22.9, -43.5],
                zoom: 8,
                apiFrames: '/api/frames/mendanha',
                apiFrame: '/api/frame/mendanha/'
            },
            sumare: {
                bounds: [[-24.431567, -45.336972], [-21.478793, -41.159092]],
                center: [-22.9332614, -43.4324536],
                zoom: 9,
                apiFrames: '/api/frames/sumare',
                apiFrame: '/api/frame/sumare/'
            }
        };

        const radarState = {
            mendanha: { 
                map: null, 
                frames: [], 
                overlays: [], 
                currentFrame: 0, 
                isPlaying: false, 
                interval: null, 
                imagesReady: false 
            },
            sumare: { 
                map: null, 
                frames: [], 
                overlays: [], 
                currentFrame: 0, 
                isPlaying: false, 
                interval: null, 
                imagesReady: false 
            }
        };

        // Detectar se √© mobile
        function isMobile() {
            return window.innerWidth <= 768;
        }

        // Ajustar zoom baseado no tamanho da tela
        function getZoom(radar) {
            const baseZoom = RADAR_CONFIG[radar].zoom;
            if (window.innerWidth <= 480) return baseZoom - 1;
            return baseZoom;
        }

        // Mobile tabs
        document.querySelectorAll('.mobile-tab').forEach(tab => {
            tab.onclick = function() {
                const panelName = this.dataset.panel;
                
                // Atualizar tabs
                document.querySelectorAll('.mobile-tab').forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // Mostrar painel correspondente
                document.querySelectorAll('.panel').forEach(p => p.classList.remove('active-mobile'));
                document.querySelector(`.panel[data-radar="${panelName}"]`).classList.add('active-mobile');
                
                // Redimensionar mapa ap√≥s troca
                setTimeout(() => {
                    if (radarState[panelName] && radarState[panelName].map) {
                        radarState[panelName].map.invalidateSize();
                    }
                }, 100);
            };
        });

        async function createAllOverlays(radar) {
            const config = RADAR_CONFIG[radar];
            const state = radarState[radar];
            
            state.overlays.forEach(overlay => {
                if (overlay) state.map.removeLayer(overlay);
            });
            state.overlays = [];
            state.imagesReady = false;
            
            const loading = document.getElementById(`loading-${radar}`);
            loading.style.display = 'block';
            loading.querySelector('div:last-child').textContent = 'Carregando... 0/' + state.frames.length;
            
            let loadedCount = 0;
            
            for (let i = 0; i < state.frames.length; i++) {
                const filename = state.frames[i];
                const url = config.apiFrame + filename;
                
                await new Promise((resolve) => {
                    const img = new Image();
                    img.onload = () => {
                        loadedCount++;
                        loading.querySelector('div:last-child').textContent = 'Carregando... ' + loadedCount + '/' + state.frames.length;
                        resolve();
                    };
                    img.onerror = () => {
                        loadedCount++;
                        resolve();
                    };
                    img.src = url;
                });
                
                const overlay = L.imageOverlay(url, config.bounds, { opacity: 0 });
                overlay.addTo(state.map);
                state.overlays.push(overlay);
            }
            
            if (state.overlays.length > 0) {
                state.overlays[0].setOpacity(BASE_OPACITY);
            }
            
            state.imagesReady = true;
            loading.style.display = 'none';
        }

        function initMaps() {
            const darkTile = 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';
            const streetsTile = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
            
            ['mendanha', 'sumare'].forEach(radar => {
                const config = RADAR_CONFIG[radar];
                const state = radarState[radar];
                
                state.map = L.map(`map-${radar}`, {
                    center: config.center,
                    zoom: getZoom(radar),
                    zoomControl: true
                });
                
                // Escolher tile baseado no tema atual
                const tileUrl = isDarkMode ? darkTile : streetsTile;
                state.tileLayer = L.tileLayer(tileUrl).addTo(state.map);
                
                loadFrames(radar);
            });
        }
        
        // Fun√ß√£o para trocar tile layer dos mapas do mosaico
        function switchMosaicMaps(toStreets) {
            const darkTile = 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';
            const streetsTile = 'https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png';
            const tileUrl = toStreets ? streetsTile : darkTile;
            
            ['mendanha', 'sumare'].forEach(radar => {
                const state = radarState[radar];
                if (state.map && state.tileLayer) {
                    state.map.removeLayer(state.tileLayer);
                    state.tileLayer = L.tileLayer(tileUrl).addTo(state.map);
                }
            });
        }

        async function loadFrames(radar) {
            const config = RADAR_CONFIG[radar];
            const state = radarState[radar];
            
            try {
                const res = await fetch(config.apiFrames);
                const data = await res.json();
                state.frames = data.frames || [];
                
                if (state.frames.length > 0) {
                    await createAllOverlays(radar);
                    showFrame(radar, 0);
                    startPlayback(radar);
                }
            } catch (e) {
                console.error(`Erro ao carregar frames ${radar}:`, e);
                document.getElementById(`loading-${radar}`).style.display = 'none';
            }
        }

        function showFrame(radar, index) {
            const config = RADAR_CONFIG[radar];
            const state = radarState[radar];
            
            if (state.frames.length === 0 || !state.imagesReady || state.overlays.length === 0) return;
            
            if (state.overlays[state.currentFrame]) {
                state.overlays[state.currentFrame].setOpacity(0);
            }
            
            state.currentFrame = index;
            
            if (state.overlays[state.currentFrame]) {
                state.overlays[state.currentFrame].setOpacity(BASE_OPACITY);
            }
            
            const player = document.getElementById(`player-${radar}`);
            const frameCounter = player.querySelector('.frame-counter');
            const timeDisplay = player.querySelector('.time-display');
            
            frameCounter.textContent = `${index + 1}/${state.frames.length}`;
            
            const filename = state.frames[index];
            if (radar === 'mendanha') {
                const match = filename.match(/MDN-(\d{4})(\d{2})(\d{2})-(\d{2})(\d{2})/);
                if (match) {
                    timeDisplay.textContent = `${match[3]}/${match[2]} ${match[4]}:${match[5]}`;
                }
            } else {
                const now = new Date();
                timeDisplay.textContent = now.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
            }
        }

        function startPlayback(radar) {
            const state = radarState[radar];
            if (state.isPlaying || !state.imagesReady) return;
            
            state.isPlaying = true;
            updatePlayButton(radar, true);
            
            state.interval = setInterval(() => {
                const nextFrame = (state.currentFrame + 1) % state.frames.length;
                showFrame(radar, nextFrame);
            }, ANIMATION_SPEED);
        }

        function stopPlayback(radar) {
            const state = radarState[radar];
            if (!state.isPlaying) return;
            
            state.isPlaying = false;
            updatePlayButton(radar, false);
            clearInterval(state.interval);
        }

        function updatePlayButton(radar, isPlaying) {
            const player = document.getElementById(`player-${radar}`);
            const playBtn = player.querySelector('[data-action="play"]');
            playBtn.textContent = isPlaying ? '‚è∏' : '‚ñ∂';
        }

        document.querySelectorAll('.panel-player').forEach(player => {
            const radar = player.id.replace('player-', '');
            
            player.querySelectorAll('.ctrl-btn').forEach(btn => {
                btn.onclick = () => {
                    const action = btn.dataset.action;
                    const state = radarState[radar];
                    
                    if (action === 'play') {
                        if (state.isPlaying) stopPlayback(radar);
                        else startPlayback(radar);
                    } else if (action === 'prev') {
                        stopPlayback(radar);
                        const prevFrame = (state.currentFrame - 1 + state.frames.length) % state.frames.length;
                        showFrame(radar, prevFrame);
                    } else if (action === 'next') {
                        stopPlayback(radar);
                        const nextFrame = (state.currentFrame + 1) % state.frames.length;
                        showFrame(radar, nextFrame);
                    }
                };
            });
        });

        document.querySelectorAll('.layout-btn').forEach(btn => {
            btn.onclick = function() {
                document.querySelectorAll('.layout-btn').forEach(b => b.classList.remove('active'));
                this.classList.add('active');
                
                const container = document.getElementById('mosaicContainer');
                container.className = `mosaic-container layout-${this.dataset.layout}`;
                
                setTimeout(() => {
                    Object.values(radarState).forEach(state => {
                        if (state.map) state.map.invalidateSize();
                    });
                }, 300);
            };
        });

        // Resize handler
        window.addEventListener('resize', () => {
            setTimeout(() => {
                Object.values(radarState).forEach(state => {
                    if (state.map) state.map.invalidateSize();
                });
            }, 100);
        });

        initMaps();

        setInterval(() => {
            loadFrames('mendanha');
            loadFrames('sumare');
        }, 120000);
    </script>
</body>
</html>